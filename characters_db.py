# characters_db.py
from models import General
import random
import maps_db 

# --- 1. 史實核心人物 (Historical VIPs - Expanded to 150+) ---
# 格式: Name, War, Int, Ldr, Initial_Location_ID
# Location IDs: 1:許昌, 2:官渡, 3:洛陽, 4:濮陽, 5:陳留, 6:鄴城, 7:長安, 8:南皮, 13:北平
# 11:建業, 12:壽春, 14:吳郡, 15:襄陽, 16:江夏, 17:江陵, 18:成都, 19:漢中
# 30:敦煌, 42:邪馬台, 50:會稽, 60:大漠, 99:秦嶺, 103:太湖

historical_data = [
    # === 魏 (曹操軍團 - 核心與中堅) ===
    ("曹操", 88, 96, 99, 1), ("司馬懿", 68, 99, 97, 1), ("荀彧", 25, 98, 95, 1),
    ("郭嘉", 20, 99, 70, 1), ("賈詡", 30, 98, 85, 7), ("程昱", 40, 92, 70, 4),
    ("夏侯惇", 92, 60, 85, 2), ("夏侯淵", 93, 55, 88, 7), ("曹仁", 88, 70, 92, 17),
    ("曹洪", 82, 50, 75, 2), ("張遼", 94, 80, 95, 6), ("張郃", 91, 72, 88, 7),
    ("徐晃", 92, 70, 85, 1), ("于禁", 85, 75, 88, 1), ("樂進", 86, 50, 78, 1),
    ("典韋", 98, 30, 50, 1), ("許褚", 97, 35, 60, 2), ("龐德", 95, 60, 80, 7),
    ("李典", 78, 75, 72, 5), ("滿寵", 60, 85, 88, 12), ("鄧艾", 88, 95, 92, 7),
    ("鍾會", 60, 94, 90, 7), ("羊祜", 70, 90, 95, 15), ("杜預", 70, 85, 90, 17),
    ("甄宓", 30, 85, 70, 6), ("卞氏", 20, 75, 80, 1), ("曹丕", 75, 85, 80, 1),
    ("曹植", 30, 92, 40, 1), ("楊修", 25, 93, 30, 1), ("華歆", 30, 85, 70, 1),
    ("王朗", 35, 80, 70, 1), ("陳群", 25, 90, 88, 1), ("劉曄", 30, 92, 60, 5),

    # === 蜀 (劉備軍團 - 五虎與後繼者) ===
    ("劉備", 75, 78, 90, 18), ("諸葛亮", 40, 100, 99, 18), ("龐統", 35, 98, 85, 18),
    ("法正", 30, 96, 80, 18), ("徐庶", 50, 95, 80, 15), ("關羽", 97, 75, 88, 17),
    ("張飛", 99, 35, 70, 18), ("趙雲", 96, 78, 85, 19), ("馬超", 97, 45, 80, 30),
    ("黃忠", 93, 65, 80, 16), ("魏延", 92, 50, 80, 19), ("姜維", 90, 92, 90, 7),
    ("關平", 85, 65, 75, 17), ("周倉", 86, 30, 60, 17), ("關興", 84, 60, 70, 18),
    ("張苞", 85, 40, 65, 18), ("馬岱", 86, 50, 75, 19), ("王平", 80, 75, 85, 19),
    ("廖化", 78, 65, 75, 17), ("嚴顏", 82, 60, 78, 18), ("黃月英", 30, 95, 60, 18),
    ("孫尚香", 85, 70, 60, 11), ("孟獲", 85, 20, 70, 99), ("祝融", 88, 40, 65, 99),
    ("孟優", 75, 20, 50, 99), ("木鹿大王", 80, 10, 60, 99), ("兀突骨", 90, 5, 40, 99),
    ("蔣琬", 30, 90, 88, 18), ("費禕", 30, 88, 85, 18), ("馬良", 25, 88, 70, 17),

    # === 吳 (孫家 - 江東才俊) ===
    ("孫權", 70, 82, 95, 11), ("孫策", 95, 70, 92, 12), ("孫堅", 92, 75, 90, 16),
    ("周瑜", 75, 97, 98, 11), ("魯肅", 40, 95, 92, 11), ("呂蒙", 80, 90, 92, 17),
    ("陸遜", 70, 96, 95, 17), ("甘寧", 94, 60, 85, 16), ("太史慈", 95, 65, 82, 14),
    ("周泰", 92, 30, 60, 11), ("凌統", 88, 50, 70, 14), ("程普", 82, 70, 85, 16),
    ("黃蓋", 83, 65, 80, 104), ("韓當", 80, 60, 75, 103), ("徐盛", 82, 75, 85, 11),
    ("丁奉", 84, 60, 80, 11), ("朱然", 75, 70, 85, 17), ("諸葛謹", 40, 88, 85, 11),
    ("張昭", 20, 90, 85, 11), ("張紘", 25, 88, 80, 11), ("顧雍", 30, 85, 80, 14),
    ("大喬", 20, 85, 60, 12), ("小喬", 20, 85, 60, 11), ("步練師", 25, 80, 70, 11),
    ("全琮", 75, 75, 80, 50), ("賀齊", 80, 70, 85, 50),

    # === 袁紹與河北名將 ===
    ("袁紹", 70, 70, 85, 6), ("顏良", 95, 30, 70, 6), ("文醜", 96, 25, 65, 6),
    ("田豐", 20, 94, 80, 6), ("沮授", 30, 92, 85, 6), ("張郃", 91, 72, 88, 8),
    ("高覽", 86, 55, 70, 8), ("審配", 50, 85, 80, 6), ("逢紀", 30, 82, 60, 6),
    ("郭圖", 35, 75, 50, 8), ("袁術", 60, 50, 40, 12), ("紀靈", 85, 40, 70, 12),

    # === 荊州劉表與西涼 ===
    ("劉表", 40, 75, 65, 15), ("蔡貌", 70, 70, 80, 15), ("張允", 65, 60, 75, 15),
    ("黃祖", 70, 60, 70, 16), ("文聘", 85, 70, 85, 15), ("蒯良", 20, 85, 70, 15),
    ("韓遂", 75, 70, 80, 30), ("馬騰", 85, 50, 80, 30), ("華雄", 92, 30, 60, 3),
    
    # === 群雄與方外之人 ===
    ("呂布", 100, 30, 80, 4), ("貂蟬", 20, 80, 60, 3), ("陳宮", 40, 90, 80, 4),
    ("高順", 88, 50, 85, 4), ("呂玲綺", 88, 60, 65, 4),
    ("董卓", 88, 50, 80, 3), ("李儒", 20, 93, 70, 3),
    ("公孫瓚", 82, 60, 75, 13), ("公孫度", 75, 65, 75, 13),
    ("張角", 60, 85, 95, 6), ("張寶", 70, 75, 80, 6), ("張梁", 80, 60, 75, 6),
    ("左慈", 10, 99, 10, 99), ("于吉", 10, 98, 10, 50), ("華佗", 20, 98, 20, 12),

    # === 異族與海外 (Global) ===
    ("卑彌呼", 50, 98, 95, 42), ("難升米", 60, 70, 65, 42), ("壹與", 30, 90, 85, 42),
    ("蹋頓", 85, 40, 75, 60), ("軻比能", 88, 55, 80, 102), ("步度根", 85, 50, 75, 60),
    ("呼廚泉", 80, 45, 70, 60), ("蔡文姬", 15, 92, 50, 60), # 被擄走時
    ("衛溫", 60, 60, 70, 50), ("諸葛直", 55, 65, 60, 50), # 探索夷洲
]

# --- 2. 程序化填充演算法 (Procedural Generation) ---

surnames = "趙錢孫李周吳鄭王馮陳褚衛蔣沈韓楊朱秦尤許何呂施張孔曹嚴華金魏陶姜"
names_1 = "伯仲叔季文武忠孝仁義禮智信德昭明輝光顯達震驚天動海山雲風雷電神鬼龍虎"
names_2 = "一二三四五六七八九十元亨利貞乾坤陰陽"

def generate_mass_generals(target_count=350): # 目標總數 350 (150史實 + 200隨機)
    current_list = []
    
    # 1. 載入 150+ 史實名將
    for data in historical_data:
        name, war, int_, ldr, loc = data
        gen = General(name, war, int_, ldr, location_id=loc)
        
        # 史實武將給予較高初始資金與好感度潛力
        gen.gold = random.randint(1000, 3000)
        # 隨機賦予史實武將一些初始裝備機率
        if random.random() < 0.3: 
            # 這裡簡單隨機給，實際可綁定特定裝備
             pass 
        current_list.append(gen)
        
    # 2. 計算需要補充的數量 (隨機大眾臉)
    needed = target_count - len(current_list)
    if needed < 0: needed = 0
    
    # 獲取所有合法的城市 ID
    valid_locs = list(maps_db.cities.keys())
    
    for _ in range(needed):
        # 隨機命名
        name = random.choice(surnames) + random.choice(names_1) + random.choice(names_2)
        
        # 隨機數值 (常態分佈，平均值較低，模擬普通將領)
        war = int(random.gauss(45, 12))
        int_ = int(random.gauss(45, 12))
        ldr = int(random.gauss(45, 12))
        
        # 修正邊界
        war = max(10, min(85, war))
        int_ = max(10, min(85, int_))
        ldr = max(10, min(85, ldr))
        
        # 隨機分配地點
        loc = random.choice(valid_locs)
        
        gen = General(name, war, int_, ldr, location_id=loc)
        gen.gold = random.randint(100, 800) # 大眾臉比較窮
        current_list.append(gen)
        
    return current_list

# 初始化：這會產生約 350-360 人
all_generals = generate_mass_generals(360)

# --- 3. 全局模擬函數 (World Simulation) ---

def simulate_world_turn():
    """
    世界回合同步：
    讓所有武將有機會移動或成長
    """
    move_log = []
    
    for gen in all_generals:
        if gen.name == "軒轅無名":
            continue
            
        # 1. 移動邏輯 (15% 機率移動 - 人多了機率調低一點以免訊息爆炸)
        if random.random() < 0.15:
            current_city = maps_db.cities.get(gen.location_id)
            if current_city and current_city.get('connections'):
                next_loc = random.choice(current_city['connections'])
                gen.location_id = next_loc
                
                # 只有數值 > 85 的名將移動才記錄，避免洗版
                if gen.get_total_stat('war') > 85 or gen.get_total_stat('int_') > 85:
                    target_city = maps_db.cities[next_loc]
                    # 只記錄切換區域的移動 (例如從豫州去兗州)，同區域移動忽略
                    if current_city.get('region') != target_city.get('region'):
                         move_log.append(f"傳聞：{gen.name} 離開了{current_city['region']}，前往 {target_city['name']}。")

        # 2. 成長邏輯 (5% 機率自我修煉)
        if random.random() < 0.05:
            growth = random.choice(['war', 'int_', 'ldr'])
            gen.grow(growth, 1)
            
    return move_log
